{% extends 'base_template.html' %}

{% block title %}Analysis Results{% endblock %}

{% block pageheader %}<h1>Analysis Results<br><small>This page displays the results of the motif analysis on the requested sequence collections.</small></h1>{% endblock %}

{% block content %}
    <div class="well">
        <h3>Analysis Details</h3>
        <p><strong>Motifs:</strong> {{ motifs }}</p>
        <p><strong>Number of Sequences:</strong> {{ sequence_count }}</p>
        <p><strong>Motif Frequency (in frame):</strong> {{ motif_frequency }} Occurrences</p>
        <p><strong>Motif Frame Size:</strong> {{ motif_frame_size }} Amino Acids</p>
        <p><strong>Analysis Completed:</strong> <span id="analysis_completed">Not Completed...</span></p>
    </div>

    <div class="top30" id="results">
        <h2>Results</h2>
    </div>

{% endblock %}

{% block script %}
    <script>
        var interval = null;

        $(document).ready( function() {
            interval = setInterval(checkQueryStatus(), 10000);
        });

        function checkQueryStatus () {
            $.post("/status/", function (data) {
                data = $.parseJSON(data);
                if (data.query_done === true) {
                    $("#analysis_completed").text('Completed!');
                    clearInterval(interval);
                    getResults();
                }
            });
        }

        function getResults () {
            $.post("/get_results/", function (data) {
                data = $.parseJSON(data);
                var results = data.query.result[0].result;
                // console.log(results);
                for (var i = 0; i < results.length; i++) {
                    var sequenceDescription = results[i].sequence.sequence_description;
                    var sequence = results[i].sequence.sequence;
                    var motif = [];
                    var matchList = [];
                    console.log(sequenceDescription);
                    console.log(sequence);
                    for (var j = 0; j < results[i].analysis.length; j++) {
                        motif.push(results[i].analysis[j].motif);
                        console.log(motif[j]);
                        var matchListInner = [];
                        for (var k = 0; k < results[i].analysis[j].raw_data.length; k++) {
                            matchListInner.push(JSON.stringify(results[i].analysis[j].raw_data[k]));
                            console.log(matchListInner[k]);
                        }
                        matchList.push(matchListInner);
                    }
                    var tableHTML = "<table class=\"table table-bordered top15 col-xs-12\">" +
                            "<tr><td>" + sequenceDescription + "</td></tr>" +
                            "<tr><td>" + sequence + "</td></tr>" +
                            "<tr><td>" + motif + "</td></tr>" +
                            "<tr><td>" + matchList + "</td></tr>" +
                            "</table";
                    $("#results").append(tableHTML);
                }
            })
        }
    </script>
{% endblock %}