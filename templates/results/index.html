{% extends 'base_template.html' %}

{% block title %}Analysis Results{% endblock %}

{% block pageheader %}<h1>Analysis Results<br><small>This page displays the results of the motif analysis on the requested sequence collections.</small></h1>{% endblock %}

{% block content %}
    <div class="well">
        <h3>Analysis Details</h3>
        <p><strong>Motifs:</strong> {{ motifs }}</p>
        <p><strong>Number of Sequences:</strong> {{ sequence_count }}</p>
        <p><strong>Motif Frequency (in frame):</strong> {{ motif_frequency }} Occurrences</p>
        <p><strong>Motif Frame Size:</strong> {{ motif_frame_size }} Amino Acids</p>
        <p><strong>Analysis Completed:</strong> <span id="analysis_completed">Not Completed...</span></p>
    </div>

    <div class="top15">
        <h3>Positive Results</h3>
        <p class="text-muted">This is a list of sequences analyzed which contain one or more matches for the requested motif analysis. A full list of analysis results is also
        available for download as a .CSV spreadsheet upon completion of the analysis.</p>
    </div>
    <div class="top15" id="results"></div>

{% endblock %}

{% block script %}
    <script>
        var interval = null;

        $(document).ready( function() {
            interval = setInterval(checkQueryStatus(), 10000);
        });

        function checkQueryStatus () {
            $.post("/status/", function (data) {
                data = $.parseJSON(data);
                if (data.query_done === true) {
                    $("#analysis_completed").text('Completed!');
                    clearInterval(interval);
                    getResults();
                }
            });
        }

        function getResults () {
            $.post("/get_results/", function (data) {
                data = $.parseJSON(data);
                console.log(data);

                for (var i = 0; i < data.length; i++) {

                    var outerTableHTML = "<table class=\"table table-bordered table-responsive\">"
                        + "<tr><td><strong>Sequence Description</strong></td><td class=\"is-breakable\">"
                        + data[i].sequence.sequence_description + "</td></tr>"
                        + "<tr><td><strong>Sequence</strong></td><td class=\"is-breakable\">"
                        + data[i].sequence.sequence + "</td></tr>"
                        + "<tr><td><strong>Motif(s)</strong></td><td class=\"is-breakable\">";

                    var analysisArray = data[i].analysis;
                    for (var j = 0; j < analysisArray.length; j++) {

                        var innerTableHTML = "<table class=\"table table-bordered table-hover table-responsive\">"
                            + "<tr><td><strong>Motif</strong></td><td class=\"is-breakable\">"
                            + analysisArray[j].motif + "</td></tr>";

                        var motifDataArray = analysisArray[j].motif_data;
                        if (motifDataArray) {
                            for (var k = 0; k < motifDataArray.length; k++) {

                                var motifDataString = "";

                                var motifArray = motifDataArray[k];
                                if (motifArray) {
                                    for (var l = 0; l < motifArray.length; l++) {
                                        motifDataString += motifArray[l].group + ": ["
                                            + motifArray[l].span[0] + ", "
                                            + motifArray[l].span[1] + "] ";
                                    }
                                    innerTableHTML += "<tr><td><strong>Motif Data</strong></td><td class=\"is-breakable\">"
                                        + motifDataString + "</td></tr>";
                                }

                            }
                        }


                        innerTableHTML += "</table>";
                    }

                    outerTableHTML += innerTableHTML + "</td></tr></table>";

                    $("#results").append(outerTableHTML);
                }

            })
        }
    </script>
{% endblock %}