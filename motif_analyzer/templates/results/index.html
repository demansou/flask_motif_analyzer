{% extends 'base_template.html' %}

{% block title %}Analysis Results{% endblock %}

{% block pageheader %}<h1>Analysis Results<br><small>This page displays the results of the motif analysis on the requested sequence collections.</small></h1>{% endblock %}

{% block content %}
    <div class="well">
        <h3>Analysis Parameters</h3>
        <p><strong>Motifs:</strong> {{ motif_str_list }}</p>
        <p><strong>Number of Sequences:</strong> {{ sequence_count }}</p>
        <p><strong>Motif Frequency (in frame):</strong> {{ motif_frequency }} Occurrences</p>
        <p><strong>Motif Frame Size:</strong> {{ motif_frame_size }} Amino Acids</p>
        <p><strong>Analysis Completed:</strong> <span id="analysis_completed">Not Completed...</span></p>
    </div>
    <div class="row">
        <div class="col-xs-12 top15" id="download_link" style="display:none;">
            <a href="/download_results/" class="btn btn-primary btn-block btn-lg" download>Download Results (.csv)</a>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <h3><span id="num_positive_results"></span> Positive Results</h3>
            <p class="text-muted">This is a list of sequences analyzed which contain one or more matches for the requested motif analysis. A full list of analysis results is also
            available for download as a .CSV spreadsheet upon completion of the analysis.</p>
        </div>

    </div>
    <div class="row">
        <div class="alert alert-danger" id="start_analysis_error" style="display:none;"></div>
        <div class="alert alert-danger" id="count_results_error" style="display:none;"></div>
    </div>
    <div class="top15" id="results"></div>

{% endblock %}

{% block script %}
    <script>
        var interval = null;

        $(document).ready(function () {
            startAnalysis();
        });

        function startAnalysis () {
            $.post('/start_analysis/').done(function (data) {
                data = JSON.parse(data);
                if (data.error === true || data.started === false) {
                    $("#start_analysis_error").text(data.message).show().fadeIn(1000);
                }
                else {
                    interval = setInterval(countResults(), 5000);
                }
            });
        }

        function countResults () {
            $.post('/count_results/').done(function (data) {
                data = JSON.parse(data);
                if (data.error === true) {
                    $("#count_results_error").text(data.message).show().fadeIn(1000);
                }
                else {
                    clearInterval(interval);
                    $('#analysis_completed').text('Completed!');
                    getResults();
                }
            })
        }

        function getResults () {
            $.post('/get_results/').done(function (data) {
                data = JSON.parse(data);
                console.log(data);
                var resultsDataArray = data.data;
                for (var i = 0; i < resultsDataArray.length; i++) {
                    var resultHTML = generateHTML(resultsDataArray[i]);
                    $('#results').append(resultHTML);
                }
            })
        }

        function generateHTML (result) {
            // if no motifs, do not generate HTML
            if (result.has_motif === false) {
                return '';
            }

            var sequenceDescription = result.sequence_description;
            var sequence = result.sequence;
            var analysis = result.analysis;
            var innerTableHTML = generateInnerTableHTML(analysis, sequence);
            var resultHTML = generateOuterTableHTML(sequenceDescription, innerTableHTML);
            return resultHTML
        }

        function analysisResultToString(analysisResultArray) {
            var analysisResultString = '';
            for (var i = 0; i < analysisResultArray.length; i++) {
                analysisResultString += 'Match: ' + analysisResultArray[i].match
                    + ', Span: [' + analysisResultArray[i].span[0] + ','
                    + analysisResultArray[i].span[1] + ']\n';
            }
            return analysisResultString;
        }

        function motifStartPos (analysisResultArray) {
            return analysisResultArray[0].span[0];
        }

        function motifEndPos (analysisResultArray) {
            return analysisResultArray[analysisResultArray.length - 1].span[1];
        }

        function parseAnalysis (analysisKeyValue) {
            var analysisResultArray = [];
            for (var i = 0; i < analysisKeyValue.length; i++) {
                var analysisKeyValueString = analysisResultToString(analysisKeyValue[i]);
                var subsequenceStart = motifStartPos(analysisKeyValue[i]);
                var subsequenceEnd = motifEndPos(analysisKeyValue[i]);
                analysisResultArray.push([analysisKeyValueString, subsequenceStart, subsequenceEnd])
            }
            return analysisResultArray;
        }

        function generateAnalysisHTML (analysis) {
            for (var i = 0; i < analysis.length; i++) {
                for(var key in analysis[i]) {
                    var analysisResultArray = parseAnalysis(analysis[i][key]);

                }
            }
        }

        function generateInnerTableHTML (analysis, sequence) {
            for (var i = 0; i < analysis.length; i++) {
                for (var key in analysis[i]) {

                    innerTableHTML += "<tr><td>" + key + "</td><td>"
                        + generateAnalysisHTML(analysis, sequence)
                }
            }
        }

        function generateOuterTableHTML (sequenceDescription, innerTableHTML) {
            return "<table class=\"table table-bordered table-responsive\">"
                + "<tr><td><strong>Sequence ID</strong></td><td class=\"is-breakable\">"
                + sequenceDescription + "</td></tr><tr><td><strong>Motif Matches</strong>"
                + "</td><td class=\"\">" + innerTableHTML + "</td></tr></table>";
        }

    </script>
{% endblock %}